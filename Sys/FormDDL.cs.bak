
﻿/*
 * Сделано в SharpDevelop.
 * Пользователь: Травин
 * Дата: 28.09.2017
 * Время: 17:52
*/ 
 
using System;  
using System.Linq;        
using System.Windows.Forms.VisualStyles;
using FastColoredTextBoxNS;       
using System.Windows.Forms;
using System.IO;
using System.Data;     
using System.Collections.Generic;  
namespace FBA
{     
	public partial class FormDDL : FormSim
	{
		public FormDDL()
		{			
			InitializeComponent();			 	
			this.MdiParent = sys.FormMainObj;
            this.Icon = this.MdiParent.Icon;            		
		}
			
        #region Вкладка Create DDL.                                
             
        ///Загрузить все.
        private void LoadAll()
        {                                       
            sys.FileReadTextObject(tbTextSQLite, sys.PathAdditional + "NewDatabase_SQLite.sql");
            sys.FileReadTextObject(tbTextPostgres, sys.PathAdditional + "NewDatabase_Postgres.sql");
            sys.FileReadTextObject(tbTextMSSQL, sys.PathAdditional + "NewDatabase_MSSQL.sql");              
        }
        
        ///Сохранить все.
        private void SaveAll()
        {
            if (tbTextSQLite.Text   == "") return;
            if (tbTextPostgres.Text == "") return;
            if (tbTextMSSQL.Text    == "") return;              
            File.WriteAllText(sys.PathAdditional + "NewDatabase_SQLite.sql",   tbTextSQLite.Text, System.Text.Encoding.Default);
            File.WriteAllText(sys.PathAdditional + "NewDatabase_Postgres.sql", tbTextPostgres.Text, System.Text.Encoding.Default);
            File.WriteAllText(sys.PathAdditional + "NewDatabase_MSSQL.sql",    tbTextMSSQL.Text, System.Text.Encoding.Default);             
        }
        
        ///Конвертация скрипта SQL создания базы данных из кода SQLite в код Postgres.
        private void ConvertToPostgres()
        {    
           //при конвертировании DLL скриптов создания таблиц из SQLite в Postgres нужно заменить.
           //INTEGER PRIMARY KEY AUTOINCREMENT заменить на serial NOT NULL
           //DATETIME на timestamp without time zone
           //добавить в конец каждой табицы ,CONSTRAINT "pk_Form_ID" PRIMARY KEY (ID)         
           tbTextPostgres.Text = tbTextSQLite.Text;
            
           int p1 = tbTextPostgres.Text.IndexOf("CREATE TABLE");
           int p2 = -1;
           string s1 = "";
           string s2 = "";
           string TableName = "";
           while (p1 > -1)
           {
               p2 = tbTextPostgres.Text.IndexOf(");", p1);
               if ((p1 > -1) && (p2 > 0))
               {
                   s1 = tbTextPostgres.Text.Substring(p1, p2 - p1 + 2);
                   TableName = sys.StrBetweenStr(s1, "CREATE TABLE", "(").Trim();
                   s2 = s1.Replace("INTEGER PRIMARY KEY AUTOINCREMENT", "serial NOT NULL");
                   s2 = s2.Replace("DATETIME", "timestamp without time zone");               
                   s2 = s2.Replace(");", ", CONSTRAINT \"pk_" + TableName + "_ID\" PRIMARY KEY (ID));");
                   tbTextPostgres.Text = tbTextPostgres.Text.Replace(s1, s2);
               } 
               if (p2 > 0) p1 = tbTextPostgres.Text.IndexOf("CREATE TABLE", p2); else p1 = -1;
           }                          
        }
                 
        ///Конвертация скрипта SQL создания базы данных из кода SQLite в код Postgres.
        private void ConvertToMSSQL()
        {   
           //при конвертировании DLL скриптов создания таблиц из SQLite в Postgres нужно заменить.
           //INTEGER PRIMARY KEY AUTOINCREMENT заменить на serial NOT NULL
           //DATETIME на timestamp without time zone
           //добавить в конец каждой табицы ,CONSTRAINT "pk_Form_ID" PRIMARY KEY (ID)         
           tbTextMSSQL.Text = tbTextSQLite.Text;
            
           int p1 = tbTextMSSQL.Text.IndexOf("CREATE TABLE");
           int p2 = -1;
           string s1 = "";
           string s2 = "";
           string TableName = "";
           while (p1 > -1)
           {
               p2 = tbTextMSSQL.Text.IndexOf(");", p1);
               if ((p1 > -1) && (p2 > 0))
               {
                   s1 = tbTextMSSQL.Text.Substring(p1, p2 - p1 + 2);
                   TableName = sys.StrBetweenStr(s1, "CREATE TABLE", "(").Trim();
                   s2 = s1.Replace("PRIMARY KEY AUTOINCREMENT", "IDENTITY(1,1) NOT NULL");                    
                   s2 = s2.Replace(");", " CONSTRAINT [PK_" + TableName + "] PRIMARY KEY CLUSTERED ([ID] ASC));");
                   s2 = s2.Replace(" timestamp without time zone", " DATETIME ");
                   s2 = s2.Replace(" current_timestamp", " DATETIME ");                  
                   s2 = s2.Replace(" BOOLEAN", " INT");
                   s2 = s2.Replace(" BOOL", " INT");
                   s2 = s2.Replace(" TEXT,", " VARCHAR(MAX),");
                   s2 = s2.Replace(" TEXT)", " VARCHAR(MAX))");              
                   
                   tbTextMSSQL.Text = tbTextMSSQL.Text.Replace(s1, s2);
               } 
               if (p2 > 0) p1 = tbTextMSSQL.Text.IndexOf("CREATE TABLE", p2); else p1 = -1;
           }                       
        }
        
        ///Выполнить скрипт SQLite или Postgress.
        private void ExecuteScript(FastColoredTextBoxNS.FastColoredTextBox tb, Connection conLocal)
        {          
            string SQL = tb.SelectedText;
            if (SQL == "") SQL = tb.Text;              
            if (conLocal.Exec(SQL)) sys.SM("Выполнено!", "Information");
        }
        
        ///Создание необходимых таблиц для работы Дизайнера и клиента в базе данных.
        private void CreateTables()
        {                             
            if (sys.ErrorCheck(!sys.conSys.ConnectionActive,  "В настоящее время нет соединения с базой!")) return;
            string FileName = sys.PathMain + "newdatabase_" + sys.conSys.ServerType + ".sql";
            if (sys.ErrorCheck(!(System.IO.File.Exists(FileName)), "Не найден файл:" + FileName)) return;                   
            if (!(sys.SM("Текущее соединение с базой " + sys.conSys.ServerType + ". Создать новую базу данных?", "Question"))) return;
            string SQL = System.IO.File.ReadAllText(FileName, System.Text.Encoding.Default);
            if (sys.Exec("Remote", SQL) == false) return;
            sys.SM("Таблицы в базе данных созданы!", "Information");
        }
        
        //Кнопки комманд DDL
        private void TbDDL1Click(object sender, EventArgs e)
        {
            string SenderName = sys.GetSenderName(sender);
           
            if (SenderName == "tbDDL1") LoadAll();
            if (SenderName == "tbDDL2") SaveAll();
            
            //Конвертация скрипта SQL в код Postgres и MSSQL.
            if (SenderName == "tbDDL3")
            {
                ConvertToPostgres();
                ConvertToMSSQL();
            }
            
            //Новая база данных. 
            if (SenderName == "tbDDL4") CreateTables();
            //Выполнить скрипт SQLite.
            if (SenderName == "tbDDL5") ExecuteScript(tbTextSQLite, sys.conLite);   
            //Выполнить скрипт Postgress. 
            if (SenderName == "tbDDL6") ExecuteScript(tbTextPostgres, sys.conLite);
            //Выполнить скрипт MSSQL.            
            if (SenderName == "tbDDL7") ExecuteScript(tbTextMSSQL, sys.conLite);                        
        }          
        
        #endregion 
       
          
        private string GetSQLCreateArh()
        {
            const string SQL = "--===================================================================== " + sys.CR +
            "--Подготовка таблиц для парсера.                                                     " + sys.CR +
            "BEGIN TRY DROP TABLE EntityParent END TRY BEGIN CATCH END CATCH                      " + sys.CR +
            "BEGIN TRY DROP TABLE #EntityParser END TRY BEGIN CATCH END CATCH                     " + sys.CR +
            "BEGIN TRY DROP TABLE #AttrParent END TRY BEGIN CATCH END CATCH                       " + sys.CR +
            "BEGIN TRY DROP TABLE #AttrChild END TRY BEGIN CATCH END CATCH                        " + sys.CR +
            "BEGIN TRY DROP TABLE #Entity END TRY BEGIN CATCH END CATCH                           " + sys.CR +
            "BEGIN TRY DROP TABLE #Attr END TRY BEGIN CATCH END CATCH                             " + sys.CR +
            "BEGIN TRY DROP TABLE #Attribute END TRY BEGIN CATCH END CATCH                        " + sys.CR +
            "--=====================================================================              " + sys.CR +
            "                                                                                     " + sys.CR +
            "--=====================================================================              " + sys.CR +
            "--Таблица #EntityParser с сущностями.                                                " + sys.CR +
            "SELECT ROW_NUMBER() OVER(ORDER BY ID) Pos, *                                         " + sys.CR +
            "  INTO #EntityParser FROM dbo.enEntity                                               " + sys.CR +
            "                                                                                     " + sys.CR +
            "ALTER TABLE #EntityParser ADD Table_ID varchar(100)                                  " + sys.CR +
            "ALTER TABLE #EntityParser ADD Table_Name varchar(100)                                " + sys.CR +
            "ALTER TABLE #EntityParser ADD Table_IDFieldName varchar(100)                         " + sys.CR +
            "                                                                                     " + sys.CR +
            "UPDATE #EntityParser SET Table_ID    = t2.TableID,                                   " + sys.CR +
            "                   Table_Name        = t2.Name,                                      " + sys.CR +
            "                   Table_IDFieldName = t2.IDFieldName                                " + sys.CR +
            "FROM dbo.enTable t2 WHERE t2.TableEntityID = #EntityParser.ID AND t2.Type = 1        " + sys.CR +
            "UPDATE #EntityParser SET Pos = Pos - 1                                               " + sys.CR +
            "--=====================================================================              " + sys.CR +
            "                                                                                     " + sys.CR +
            "--=====================================================================              " + sys.CR +       
            "--Таблица #EntityParent с деревом сущностей.                                         " + sys.CR +
            ";WITH Parents (EnChildID, EnBrief2, EnID, EnBrief1, ParentID, EnBriefName2, EnBriefName1) AS  " + sys.CR +
            "      (                                                                              " + sys.CR +
            "        SELECT                                                                       " + sys.CR +
            "          ID AS EnChildID,                                                           " + sys.CR +
            "          Brief AS EnBrief2,                                                         " + sys.CR +
            "          ID as EnID,                                                                " + sys.CR +
            "          Brief as EnBrief1,                                                         " + sys.CR +
            "          ParentID,                                                                  " + sys.CR +
            "          Name as EnBriefName2,                                                      " + sys.CR +
            "          Name as EnBriefName1                                                       " + sys.CR +
            "        FROM dbo.enEntity                                                            " + sys.CR +
            "        UNION ALL                                                                    " + sys.CR +
            "        SELECT                                                                       " + sys.CR +
            "          EnChildID,                                                                 " + sys.CR +
            "          EnBrief2,                                                                  " + sys.CR +
            "          e.ID as EnID,                                                              " + sys.CR +
            "          e.Brief as EnBrief1,                                                       " + sys.CR +
            "          e.ParentID,                                                                " + sys.CR +
            "          p.EnBriefName2 as EnBriefName2,                                            " + sys.CR +
            "          e.Name as EnBriefName1                                                     " + sys.CR +
            "        FROM dbo.enEntity e INNER JOIN Parents p ON p.ParentID = e.ID                " + sys.CR +
            "      ) SELECT * INTO #EntityParent FROM Parents ORDER BY EnBrief2, EnBrief1;        " + sys.CR +
            "                                                                                     " + sys.CR +
            "ALTER TABLE #EntityParent ADD EnBrief2_TableName varchar(100);         --Главная таблица сущности EnBrief2.                " + sys.CR +
            "ALTER TABLE #EntityParent ADD EnBrief2_TableIDFieldName varchar(100);  --ИД поля автоинкремента таблицы сущности EnBrief2. " + sys.CR +
            "ALTER TABLE #EntityParent ADD EnBrief1_TableName varchar(100);         --Главная таблица сущности EnBrief1.                " + sys.CR +
            "ALTER TABLE #EntityParent ADD EnBrief1_TableIDFieldName varchar(100);  --ИД поля автоинкремента таблицы сущности EnBrief1. " + sys.CR +     
            "                                                                                     " + sys.CR +
            "--Данные по таблице для сущности EnBrief2                                            " + sys.CR +
            "UPDATE #EntityParent SET                                                             " + sys.CR +
            "  #EntityParent.EnBrief2_TableName        = t1.Table_Name,                           " + sys.CR +
            "  #EntityParent.EnBrief2_TableIDFieldName = t1.Table_IDFieldName                     " + sys.CR +
            "FROM #EntityParser t1 WHERE #EntityParent.EnBrief2 = t1.Brief                        " + sys.CR +
            "                                                                                     " + sys.CR +
            "--Данные по таблице для сущности EnBrief1                                            " + sys.CR +
            "UPDATE #EntityParent SET                                                             " + sys.CR +
            "  #EntityParent.EnBrief1_TableName        = t1.Table_Name,                           " + sys.CR +
            "  #EntityParent.EnBrief1_TableIDFieldName = t1.Table_IDFieldName                     " + sys.CR +
            "FROM #EntityParser t1 WHERE #EntityParent.EnBrief1 = t1.Brief                        " + sys.CR +
            "--=====================================================================              " + sys.CR +
            "                                                                                     " + sys.CR +
            "--=====================================================================              " + sys.CR +
            "--Таблица #AttrParser с атрибутами                                                   " + sys.CR +
            "SELECT                                                                               " + sys.CR +
            "  AttributeID       AS ID,                                                           " + sys.CR +
            "  EntityID          AS EntityID,                                                     " + sys.CR +
            "  AttributeEntityID AS Attr_EntityID,                                                " + sys.CR +
            "  Name              AS Attr_Name,                                                    " + sys.CR +
            "  Brief             AS Attr_Brief,                                                   " + sys.CR +
            "  Type              AS Attr_Type,                                                    " + sys.CR +
            "  Kind              AS Attr_Kind,                                                    " + sys.CR +
            "  Mask              AS Attr_Mask,                                                    " + sys.CR +
            "  Feature           AS Attr_Feature,                                                 " + sys.CR +
            "  ObjectNameOrder   AS Attr_NameOrder,                                               " + sys.CR +
            "  Code              AS Attr_Code,                                                    " + sys.CR +
            "  Description       AS Attr_Comment,                                                 " + sys.CR +
            "  TableID           AS Table_ID,                                                     " + sys.CR +
            "  FieldName         AS Table_Field,                                                  " + sys.CR +
            "  FieldName2        AS Table_Field2,                                                 " + sys.CR +
            "  RefEntityID       AS Ref_EntityID,                                                 " + sys.CR +
            "  RefAttributeID    AS Ref_AttrID                                                    " + sys.CR +
            "INTO #AttrParser                                                                     " + sys.CR +
            "FROM dbo.enAttribute                                                                 " + sys.CR +
            "                                                                                     " + sys.CR +
            "ALTER TABLE #AttrParser ADD Table_Name varchar(100);          --Данные по таблице, в котрой находится атрибут. Имя таблицы.    " + sys.CR +
            "ALTER TABLE #AttrParser ADD Table_IDFieldName varchar(100);   --Данные по таблице, в котрой находится атрибут. ID поля автоинкремена в таблице. (Поле внешенего ключа) " + sys.CR +
            "ALTER TABLE #AttrParser ADD Table_Type int;                   --Тип таблицы (Главная или Историчная)                           " + sys.CR +
            "ALTER TABLE #AttrParser ADD Table_Feature int;                --Свойства таблицы.                                              " + sys.CR +
            "ALTER TABLE #AttrParser ADD Ref_EntityBrief varchar(100);     --Сокращение сущности для атрибута Ссылки или Массива            " + sys.CR +
            "ALTER TABLE #AttrParser ADD Ref_AttrBrief varchar(100);       --Сокращение атрибута сущности для атрибута Ссылки или Массива   " + sys.CR +
            "ALTER TABLE #AttrParser ADD Ref_AttrName varchar(100);        --Наименование атрибута сущности для атрибута Ссылки или Массива " + sys.CR +
            "ALTER TABLE #AttrParser ADD Attr_EntityBrief varchar(100);    --Сокращение сущности, к котрой относится атрибут.               " + sys.CR +
            "                                                                                     " + sys.CR +
            "--Данные по таблице атрибута                                                         " + sys.CR +
            "UPDATE #AttrParser SET                                                               " + sys.CR +
            "  #AttrParser.Table_Name        = t1.Name,                                           " + sys.CR +
            "  #AttrParser.Table_IDFieldName = t1.IDFieldName,                                    " + sys.CR +
            "  #AttrParser.Table_Feature     = t1.Feature,                                        " + sys.CR +
            "  #AttrParser.Table_Type        = t1.Type                                            " + sys.CR +
            "FROM dbo.enTable t1                                                                  " + sys.CR +
            "WHERE #AttrParser.Table_ID = t1.TableID                                              " + sys.CR +
            "                                                                                     " + sys.CR +
            "--Данные для атрибута Ссылки или Массива.                                            " + sys.CR +
            "UPDATE #AttrParser SET Ref_EntityBrief = t1.Brief FROM dbo.enEntity t1 WHERE #AttrParser.Ref_EntityID = t1.ID  " + sys.CR +
            "UPDATE #AttrParser SET Ref_AttrBrief   = t1.Brief,                                   " + sys.CR +
            "                 Ref_AttrName    = t1.Name                                           " + sys.CR +
            "FROM dbo.enAttribute t1                                                              " + sys.CR +
            "WHERE #AttrParser.Ref_AttrID = t1.AttributeID and #AttrParser.Ref_EntityID = t1.AttributeEntityID " + sys.CR +
            "                                                                                      " + sys.CR +
            "--Сущность атрибута                                                                  " + sys.CR +
            "UPDATE #AttrParser SET Attr_EntityBrief = t1.Brief FROM dbo.enEntity t1 WHERE #AttrParser.Attr_EntityID = t1.ID " + sys.CR +
            "--=====================================================================              " + sys.CR +
            "                                                                                     " + sys.CR +
            "--=====================================================================              " + sys.CR +
            "--Таблица #AttrParent с атрибутами. Для каждой сущности весь полный список атрибутов, включая предков. " + sys.CR +
            "SELECT ROW_NUMBER() OVER(ORDER BY EnBrief2) Pos, t1.*, t2.*                          " + sys.CR +
            "  INTO #AttrParent FROM #AttrParser t1                                               " + sys.CR +
            "  LEFT JOIN #EntityParent t2 ON t2.EnID = t1.Attr_EntityID                           " + sys.CR +
            "UPDATE #AttrParent   SET Pos = Pos - 1                                               " + sys.CR +
            "--=====================================================================              " + sys.CR +
            "                                                                                     " + sys.CR +
            "--=====================================================================              " + sys.CR +
            "--Таблица #AttrChild с атрибутами. Для каждой сущности список атрибутов потомков.    " + sys.CR +
            "--Работает, но пока отключено.                                                       " + sys.CR +
            "--SELECT ROW_NUMBER() OVER(ORDER BY Attr_EntityID, Attr_Brief) Pos, t1.*, t2.*       " + sys.CR +
            "--  INTO #AttrChild FROM #AttrParser t1                                              " + sys.CR +
            "--  RIGHT JOIN #EntityParent t2 ON t2.EnChildID = t1.Attr_EntityID AND t1.Attr_Brief IS NOT NULL --1716 Расчетный документ " + sys.CR + 
            "--UPDATE #AttrChild SET Pos = Pos - 1                                                " + sys.CR +   
            "--=====================================================================              " + sys.CR +
            "                                                                                     " + sys.CR +
            "--=====================================================================              " + sys.CR +
            "--Результат 5 таблиц. #AttrParser не используем, поэтому 4.                          " + sys.CR +
            "SELECT * FROM #EntityParser     ORDER BY Pos                                         " + sys.CR +
            "SELECT * FROM #AttrParent       ORDER BY Pos                                         " + sys.CR +
            "SELECT * FROM dbo.enEntity      ORDER BY ID                                          " + sys.CR +
            "SELECT * FROM dbo.enAttribute   ORDER BY AttributeID                                 " + sys.CR +
            "SELECT * FROM dbo.enTable       ORDER BY TableID                                     " + sys.CR +
            "--=====================================================================              " + sys.CR;
            return SQL;
                        
            /*   
            con.SelectDT("SELECT * FROM arhEntityParser", out DTArEntity);
                
            const string SQL = "SELECT " +
                "Pos, ID, EntityID, Attr_EntityID, Attr_Name, Attr_Brief, " +   
                "(case when Attr_Type = 1 then 'Field' " +
                "      when Attr_Type = 2 then 'Link'  " +
                "      when Attr_Type = 3 then 'UniLink' " +
                "      when Attr_Type = 4 then 'Array' " +
                "      else Attr_Type   " +
                "  end) Attr_Type,      " +           
                "(case when Attr_Kind = 1 then 'Simple' " +
                "      when Attr_Kind = 2 then 'System' " +
                "      when Attr_Kind = 3 then 'Calc'   " +
                "      else Attr_Kind   " +
                "  end) Attr_Kind,      " +
                "Attr_Mask, Attr_Feature, Attr_NameOrder, Attr_Code, Attr_Comment, Table_ID, Table_Field, Table_Field2, " +
                "Ref_EntityID, Ref_AttrID, Table_Name, Table_IDFieldName, " +                   
                "(case when Table_Type = 1 then 'Main' " +
                "      when Table_Type = 2 then 'Hist'  " +                                
                "      else Table_Type   " +
                "  end) Table_Type,      " +                                                  
                "Table_Feature,                    " +
                "Ref_EntityBrief, Ref_AttrBrief, Ref_AttrName, Attr_EntityBrief, EnChildID, EnBrief2, EnID,             " +
                "EnBrief1, ParentID, EnBriefName2, EnBriefName1, EnBrief2_TableName, EnBrief2_TAbleIDFieldName, EnBrief1_TableName, EnBrief1_TAbleIDFieldName " +
                "FROM arhAttrParent";
               */
        }
        
        ///Скопировать таблицу из локальной базы на сервер.
        private bool CopyTableToLocal(System.Data.DataTable DT, string TableName, ref string ResultInfo, ref int CountTables)
        {
            sys.DTView(DT, TableName, TableName);
            string SQL = sys.GetTextTableToDatabase("SQLite", TableName, DT, true);             
            if (!sys.conLite.Exec(SQL)) return false;
            ResultInfo = ResultInfo + "Таблица " + TableName + " сохранена в локальной базе данных SQLite" + sys.CR;
            CountTables++;
            return true;
        }
        
        ///Скопировать таблицы из локальной базы на сервер.
        private bool CreateParserLocalTables()
        {
            string SQL = GetSQLCreateArh(); 
            //sys.SM(SQL);
            if (sys.con.ServerType != "MSSQL") return false;
            var DS = new System.Data.DataSet();
            sys.con.SelectDS(SQL, out DS);
            //#EntityParser   arhEntityParser                      
            //#AttrParent     arhAttrParent  
            //dbo.enEntity    arhEntity                                 
            //dbo.enAttribute arhAttr
            //dbo.enTable     arhTable
            string ResultInfo = "";
            int CountTables = 0;                               
            CopyTableToLocal(DS.Tables[0], "arhEntityParser", ref ResultInfo, ref CountTables);
            CopyTableToLocal(DS.Tables[1], "arhAttrParent",   ref ResultInfo, ref CountTables);
            CopyTableToLocal(DS.Tables[2], "arhEntity",       ref ResultInfo, ref CountTables);
            CopyTableToLocal(DS.Tables[3], "arhAttr",         ref ResultInfo, ref CountTables);
            CopyTableToLocal(DS.Tables[4], "arhTable",        ref ResultInfo, ref CountTables);
                                                                
            if (CountTables != 5)              
                sys.SM("При копировании таблиц возникли ошибки:" + sys.CR + ResultInfo, "Error");
            else sys.SM("Копирование таблиц успешно завершено:" + sys.CR + ResultInfo, "Information");
            return (CountTables == 5);
        }
             
        ///Копирование таблиц на удаленный сервер.
        private void cmMenuN_1_Click(object sender, EventArgs e)
        {                                            
            string SQL = "SELECT Name FROM sqlite_master WHERE type = 'table'";
            System.Data.DataTable DT;
            sys.SelectDT("Local", SQL, out DT);
            int CountTables = 0;
            string ResultInfo = "";
            for (int i = 0; i < DT.Rows.Count; i++) 
            {               
                string TableName = sys.DTValue(DT, i, "Name");
                SQL = "if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[" + TableName + "]') and OBJECTPROPERTY(id, N'IsUserTable') = 1) " + sys.CR +
                      "drop table [dbo].[" + TableName + "] ";
                                       
                if (!sys.Exec("Remote", SQL)) return;                               
                System.Data.DataTable DT2;
                SQL = "SELECT * FROM " + TableName;
                sys.SelectDT("Local", SQL, out DT2);
               
                //Способ sys.con.MSSQLCopyTableToServer работает быстрее для MSSQL, чем sys.GetTextTableToDatabase.
                if (sys.con.MSSQLCopyTableToServer(DT2, TableName)) 
                {
                    ResultInfo = ResultInfo + "Таблица " + TableName + " сохранена в удаленной базе данных" + sys.CR;
                    CountTables++;
                }
            }
            if (CountTables != DT.Rows.Count)              
                sys.SM("При копировании таблиц возникли ошибки:" + sys.CR + ResultInfo, "Error");
            else sys.SM("Копирование таблиц успешно завершено:" + sys.CR + ResultInfo, "Information");          
       }
        
        ///Копирование таблиц на в локальнуюБД.
        private void cmMenuN_2_Click(object sender, EventArgs e)
        {
            CreateParserLocalTables();
        }
         
        
        
	}
}
