-- var mtQuery: TmcMemTable;
-- mtQuery := TmcMemTable.Create(Application);
-- SelectSQL('exec dbo.АдмПроцедура2 1304, ''Ошибки дедубликации.'' ', mtQuery);
begin tran

SELECT * INTO #MyTbl

FROM (

select '4909910565' INN, '490901001' KPP, '41190' ID UNION ALL

SELECT '4909910565'
 , '490901001'
 , '258176' UNION ALL

SELECT '2709003904'
 , '270901001'
 , '42577' UNION ALL

SELECT '2709003904'
 , '270901001'
 , '258533' UNION ALL

SELECT '6625004698'
 , '662501001'
 , '313486' UNION ALL

SELECT '6625004698'
 , '662501001'
 , '303571' UNION ALL

SELECT '7708532326'
 , '770801001'
 , '287443' UNION ALL

SELECT '7708532326'
 , '770801001'
 , '4337' UNION ALL

SELECT '7728199296'
 , '772801001'
 , '61297' UNION ALL

SELECT '7728199296'
 , '772801001'
 , '92043' UNION ALL

SELECT '7202154817'
 , '720301001'
 , '91650' UNION ALL

SELECT '7202154817'
 , '720301001'
 , '466720' UNION ALL

SELECT '5405177439'
 , '540501001'
 , '1691117' UNION ALL

SELECT '5405177439'
 , '540501001'
 , '1693054' UNION ALL

SELECT '5407014302'
 , '540701001'
 , '109844' UNION ALL

SELECT '5407014302'
 , '540701001'
 , '109848' UNION ALL

SELECT '6670106652'
 , '667001001'
 , '61353' UNION ALL

SELECT '6670106652'
 , '667001001'
 , '185803' UNION ALL

SELECT '5402525254'
 , '540201001'
 , '259445' UNION ALL

SELECT '5402525254'
 , '540201001'
 , '181294' UNION ALL

SELECT '6319115960'
 , '631901001'
 , '267964' UNION ALL

SELECT '6319115960'
 , '631901001'
 , '82024' UNION ALL

SELECT '7203075734'
 , '720301001'
 , '453671' UNION ALL

SELECT '7203075734'
 , '720301001'
 , '62762' UNION ALL

SELECT '1832089316'
 , '183201001'
 , '221220' UNION ALL

SELECT '1832089316'
 , '183201001'
 , '222958' UNION ALL

SELECT '5406139980'
 , '540601001'
 , '1693079' UNION ALL

SELECT '5406139980'
 , '540601001'
 , '1691125' UNION ALL

SELECT '6317004848'
 , '631601001'
 , '89005' UNION ALL

SELECT '6317004848'
 , '631601001'
 , '62746' UNION ALL

SELECT '2203000218'
 , '220301001'
 , '187463' UNION ALL

SELECT '2203000218'
 , '220301001'
 , '96782' UNION ALL

SELECT '7705908002'
 , '770501001'
 , '1691253' UNION ALL

SELECT '7705908002'
 , '770501001'
 , '321443' UNION ALL

SELECT '2221022461'
 , '222101001'
 , '229992' UNION ALL

SELECT '2221022461'
 , '222101001'
 , '385821' UNION ALL

SELECT '7448047685'
 , '744801001'
 , '195244' UNION ALL

SELECT '7448047685'
 , '744801001'
 , '196060' UNION ALL

SELECT '7731662362'
 , '773101001'
 , '3845' UNION ALL

SELECT '7731662362'
 , '773101001'
 , '117126' UNION ALL

SELECT '7710007966'
 , '770901001'
 , '295511' UNION ALL

SELECT '7710007966'
 , '770901001'
 , '4254' UNION ALL

SELECT '7815006487'
 , '784101001'
 , '214794' UNION ALL

SELECT '7815006487'
 , '784101001'
 , '3960' UNION ALL

SELECT '7705373815'
 , '770501001'
 , '90446' UNION ALL

SELECT '7705373815'
 , '770501001'
 , '60761' UNION ALL

SELECT '1657050680'
 , '165901001'
 , '115392' UNION ALL

SELECT '1657050680'
 , '165901001'
 , '91175' UNION ALL

SELECT '2721067559'
 , '272101001'
 , '116426' UNION ALL

SELECT '2721067559'
 , '272101001'
 , '149920' UNION ALL

SELECT '2259001380'
 , '222201001'
 , '343309' UNION ALL

SELECT '2259001380'
 , '222201001'
 , '142003' UNION ALL

SELECT '3663054729'
 , '366201001'
 , '61977' UNION ALL

SELECT '3663054729'
 , '366201001'
 , '194657' UNION ALL

SELECT '2290000652'
 , '229001001'
 , '343270' UNION ALL

SELECT '2290000652'
 , '229001001'
 , '189381' UNION ALL

SELECT '2463003080'
 , '246301001'
 , '187444' UNION ALL

SELECT '2463003080'
 , '246301001'
 , '189390' UNION ALL

SELECT '7841323041'
 , '784101001'
 , '61978' UNION ALL

SELECT '7841323041'
 , '784101001'
 , '207660' UNION ALL

SELECT '2204057104'
 , '220401001'
 , '350935' UNION ALL

SELECT '2204057104'
 , '220401001'
 , '255273' UNION ALL

SELECT '1650056161'
 , '165001001'
 , '196489' UNION ALL

SELECT '1650056161'
 , '165001001'
 , '37750' UNION ALL

SELECT '2124003784'
 , '212401001'
 , '1693045' UNION ALL

SELECT '2124003784'
 , '212401001'
 , '1691151' UNION ALL

SELECT '6672195136'
 , '667201001'
 , '178639' UNION ALL

SELECT '6672195136'
 , '667201001'
 , '61345' UNION ALL

SELECT '1835049819'
 , '184101001'
 , '298051' UNION ALL

SELECT '1835049819'
 , '184101001'
 , '221865' UNION ALL

SELECT '3442007544'
 , '344201001'
 , '242450' UNION ALL

SELECT '3442007544'
 , '344201001'
 , '341662' UNION ALL

SELECT '3442007544'
 , '344201001'
 , '90507' UNION ALL

SELECT '2227008713'
 , '220401001'
 , '350219' UNION ALL

SELECT '2227008713'
 , '220401001'
 , '244248' UNION ALL

SELECT '7453094401'
 , '745301001'
 , '1692659' UNION ALL

SELECT '7453094401'
 , '745301001'
 , '1692828' UNION ALL

SELECT '5906011804'
 , '770401001'
 , '254953' UNION ALL

SELECT '5906011804'
 , '770401001'
 , '92782' UNION ALL

SELECT '7806400751'
 , '781101001'
 , '163213' UNION ALL

SELECT '7806400751'
 , '781101001'
 , '162865' UNION ALL

SELECT '5404355424'
 , '540401001'
 , '268097' UNION ALL

SELECT '5404355424'
 , '540401001'
 , '178352' UNION ALL

SELECT '7710745794'
 , '771401001'
 , '282403' UNION ALL

SELECT '7710745794'
 , '771401001'
 , '1691196' UNION ALL

SELECT '7703567318'
 , '772501001'
 , '626722' UNION ALL

SELECT '7703567318'
 , '772501001'
 , '1691782' UNION ALL

SELECT '1831080399'
 , '183101001'
 , '221070' UNION ALL

SELECT '1831080399'
 , '183101001'
 , '163841' UNION ALL

SELECT '5406684706'
 , '540601001'
 , '178505' UNION ALL

SELECT '5406684706'
 , '540601001'
 , '178506' UNION ALL

SELECT '7704195775'
 , '771001001'
 , '28890' UNION ALL

SELECT '7704195775'
 , '771001001'
 , '1692548' UNION ALL

SELECT '1831138112'
 , '183101001'
 , '164573' UNION ALL

SELECT '1831138112'
 , '183101001'
 , '222877' UNION ALL

SELECT '1831138112'
 , '183101001'
 , '243890' UNION ALL

SELECT '1655262224'
 , '165501001'
 , '44857' UNION ALL

SELECT '1655262224'
 , '165501001'
 , '297377' UNION ALL

SELECT '3123318208'
 , '312301001'
 , '1691795' UNION ALL

SELECT '3123318208'
 , '312301001'
 , '1694509' UNION ALL

SELECT '2227026624'
 , '220401001'
 , '233071' UNION ALL

SELECT '2227026624'
 , '220401001'
 , '346317' UNION ALL

SELECT '7710949942'
 , '771001001'
 , '450310' UNION ALL

SELECT '7710949942'
 , '771001001'
 , '354081' UNION ALL

SELECT '6608007473'
 , '667101001'
 , '890255' UNION ALL

SELECT '6608007473'
 , '667101001'
 , '809897' UNION ALL

SELECT '6608007473'
 , '667101001'
 , '1060536' UNION ALL

SELECT '6608007473'
 , '667101001'
 , '378782' UNION ALL

SELECT '6608007473'
 , '667101001'
 , '1256695' UNION ALL

SELECT '6608007473'
 , '667101001'
 , '1691824' UNION ALL

SELECT '2310101500'
 , '231001001'
 , '386282' UNION ALL

SELECT '2310101500'
 , '231001001'
 , '383215' UNION ALL

SELECT '2317008757'
 , '231701001'
 , '1603830' UNION ALL

SELECT '2317008757'
 , '231701001'
 , '226336' UNION ALL

SELECT '7202079599'
 , '720301001'
 , '158451' UNION ALL

SELECT '7202079599'
 , '720301001'
 , '465773' UNION ALL

SELECT '3907032867'
 , '390701001'
 , '465775' UNION ALL

SELECT '3907032867'
 , '390701001'
 , '3982' UNION ALL

SELECT '7719526980'
 , '772801001'
 , '471507' UNION ALL

SELECT '7719526980'
 , '772801001'
 , '1692921' UNION ALL

SELECT '7722796017'
 , '772201001'
 , '1694510' UNION ALL

SELECT '7722796017'
 , '772201001'
 , '1691200' UNION ALL

SELECT '3663106550'
 , '366301001'
 , '488356' UNION ALL

SELECT '3663106550'
 , '366301001'
 , '488187' UNION ALL

SELECT '3663106550'
 , '366301001'
 , '488620' UNION ALL

SELECT '3663106550'
 , '366301001'
 , '488624' UNION ALL

SELECT '7744002356'
 , '775001001'
 , '571696' UNION ALL

SELECT '7744002356'
 , '775001001'
 , '580840' UNION ALL

SELECT '6321268890'
 , '27401001'
 , '1692801' UNION ALL

SELECT '6321268890'
 , '27401001'
 , '178371' UNION ALL

SELECT '7704753003'
 , '772401001'
 , '291208' UNION ALL

SELECT '7704753003'
 , '772401001'
 , '1691307' UNION ALL

SELECT '5262117541'
 , '526201001'
 , '291893' UNION ALL

SELECT '5262117541'
 , '526201001'
 , '291911' UNION ALL

SELECT '7804504071'
 , '780401001'
 , '363149' UNION ALL

SELECT '7804504071'
 , '780401001'
 , '382615' UNION ALL

SELECT '7731025356'
 , '773101001'
 , '1010009' UNION ALL

SELECT '7731025356'
 , '773101001'
 , '1691237' UNION ALL

SELECT '7719044994'
 , '772201001'
 , '1693049' UNION ALL

SELECT '7719044994'
 , '772201001'
 , '1691120' UNION ALL

SELECT '7735572840'
 , '773501001'
 , '1692471' UNION ALL

SELECT '7735572840'
 , '773501001'
 , '554323' UNION ALL

SELECT '2204008820'
 , '220401001'
 , '346763' UNION ALL

SELECT '2204008820'
 , '220401001'
 , '203388' UNION ALL

SELECT '5406788984'
 , '540601001'
 , '1691109' UNION ALL

SELECT '5406788984'
 , '540601001'
 , '742685' UNION ALL

SELECT '1644030542'
 , '164401001'
 , '120176' UNION ALL

SELECT '1644030542'
 , '164401001'
 , '116798' UNION ALL

SELECT '1831132061'
 , '184001001'
 , '221381' UNION ALL

SELECT '1831132061'
 , '184001001'
 , '166277' UNION ALL

SELECT '4205300228'
 , '420501001'
 , '920747' UNION ALL

SELECT '4205300228'
 , '420501001'
 , '1692951' UNION ALL

SELECT '7203338905'
 , '720301001'
 , '1693097' UNION ALL

SELECT '7203338905'
 , '720301001'
 , '1691147' UNION ALL

SELECT '7707527193'
 , '770501001'
 , '1692685' UNION ALL

SELECT '7707527193'
 , '770501001'
 , '1502671' UNION ALL

SELECT '7728240723'
 , '616345001'
 , '141436' UNION ALL

SELECT '7728240723'
 , '616345001'
 , '114175' UNION ALL

SELECT '5401339262'
 , '540101001'
 , '188940' UNION ALL

SELECT '5401339262'
 , '540101001'
 , '119549' UNION ALL

SELECT '7705907009'
 , '770501001'
 , '1691258' UNION ALL

SELECT '7705907009'
 , '770501001'
 , '571699' UNION ALL

SELECT '2466159255'
 , '246601001'
 , '1693071' UNION ALL

SELECT '2466159255'
 , '246601001'
 , '1692452' UNION ALL

SELECT '1660057069'
 , '165501001'
 , '197068' UNION ALL

SELECT '1660057069'
 , '165501001'
 , '69079' UNION ALL

SELECT '2223021150'
 , '222301001'
 , '59122' UNION ALL

SELECT '2223021150'
 , '222301001'
 , '147648' UNION ALL

SELECT '6315801943'
 , '631501001'
 , '62650' UNION ALL

SELECT '6315801943'
 , '631501001'
 , '62956' UNION ALL

SELECT '2222068797'
 , '222201001'
 , '286793' UNION ALL

SELECT '2222068797'
 , '222201001'
 , '345540' UNION ALL

SELECT '5502018385'
 , '550301001'
 , '44737' UNION ALL

SELECT '5502018385'
 , '550301001'
 , '201159' UNION ALL

SELECT '5407493937'
 , '540701001'
 , '433057' UNION ALL

SELECT '5407493937'
 , '540701001'
 , '89290' UNION ALL

SELECT '0323349487'
 , '32301001'
 , '97275' UNION ALL

SELECT '0323349487'
 , '32301001'
 , '56560' UNION ALL

SELECT '6319013069'
 , '631901001'
 , '143294' UNION ALL

SELECT '6319013069'
 , '631901001'
 , '62728' UNION ALL

SELECT '2225102742'
 , '222101001'
 , '229822' UNION ALL

SELECT '2225102742'
 , '222101001'
 , '403276' UNION ALL

SELECT '2727026037'
 , '270301001'
 , '45883' UNION ALL

SELECT '2727026037'
 , '270301001'
 , '20840' UNION ALL

SELECT '6658081585'
 , '665801001'
 , '88426' UNION ALL

SELECT '6658081585'
 , '665801001'
 , '4206' UNION ALL

SELECT '2540018140'
 , '254001001'
 , '177165' UNION ALL

SELECT '2540018140'
 , '254001001'
 , '48586' UNION ALL

SELECT '2540018140'
 , '254001001'
 , '232338' UNION ALL

SELECT '0265007932'
 , '26501001'
 , '108910' UNION ALL

SELECT '0265007932'
 , '26501001'
 , '189194' UNION ALL

SELECT '2724062140'
 , '272401001'
 , '37627' UNION ALL

SELECT '2724062140'
 , '272401001'
 , '313473' UNION ALL

SELECT '5260048170'
 , '526001001'
 , '4192' UNION ALL

SELECT '5260048170'
 , '526001001'
 , '149059' UNION ALL

SELECT '7728815548'
 , '773601001'
 , '1691122' UNION ALL

SELECT '7728815548'
 , '773601001'
 , '1693077' UNION ALL

SELECT '7714836280'
 , '771401001'
 , '1691127' UNION ALL

SELECT '7714836280'
 , '771401001'
 , '1693052' UNION ALL

SELECT '6321373968'
 , '632101001'
 , '1307745' UNION ALL

SELECT '6321373968'
 , '632101001'
 , '1692696' UNION ALL

SELECT '1001047966'
 , '100101001'
 , '115384' UNION ALL

SELECT '1001047966'
 , '100101001'
 , '62622' UNION ALL

SELECT '2309130087'
 , '230901001'
 , '1693047' UNION ALL

SELECT '2309130087'
 , '230901001'
 , '1691119' UNION ALL

SELECT '7830000867'
 , '470301001'
 , '965602' UNION ALL

SELECT '7830000867'
 , '470301001'
 , '948726' UNION ALL

SELECT '3664116470'
 , '366401001'
 , '315645' UNION ALL

SELECT '3664116470'
 , '366401001'
 , '986254' UNION ALL

SELECT '7713059497'
 , '540402001'
 , '147673' UNION ALL

SELECT '7713059497'
 , '540402001'
 , '55564' UNION ALL

SELECT '7722292838'
 , '774850001'
 , '233689' UNION ALL

SELECT '7722292838'
 , '774850001'
 , '1553877' UNION ALL

SELECT '7203116211'
 , '720301001'
 , '569811' UNION ALL

SELECT '7203116211'
 , '720301001'
 , '89049' UNION ALL

SELECT '5040054932'
 , '504001001'
 , '1622903' UNION ALL

SELECT '5040054932'
 , '504001001'
 , '1622902' UNION ALL

SELECT '7728315908'
 , '772801001'
 , '1448990' UNION ALL

SELECT '7728315908'
 , '772801001'
 , '1692717' UNION ALL

SELECT '1657198077'
 , '165701001'
 , '1215610' UNION ALL

SELECT '1657198077'
 , '165701001'
 , '222515' UNION ALL

SELECT '1001289965'
 , '100101001'
 , '62660' UNION ALL

SELECT '1001289965'
 , '100101001'
 , '45456' UNION ALL

SELECT '7842510020'
 , '784201001'
 , '504428' UNION ALL

SELECT '7842510020'
 , '784201001'
 , '3788' UNION ALL

SELECT '3666091711'
 , '366601001'
 , '61920' UNION ALL

SELECT '3666091711'
 , '366601001'
 , '61923' UNION ALL

SELECT '7804431828'
 , '783801001'
 , '513686' UNION ALL

SELECT '7804431828'
 , '783801001'
 , '3916' UNION ALL

SELECT '3664095943'
 , '366401001'
 , '136903' UNION ALL

SELECT '3664095943'
 , '366401001'
 , '141463' UNION ALL

SELECT '2308073414'
 , '230801001'
 , '124779' UNION ALL

SELECT '2308073414'
 , '230801001'
 , '285798' UNION ALL

SELECT '7401000473'
 , '740101001'
 , '202982' UNION ALL

SELECT '7401000473'
 , '740101001'
 , '202870' UNION ALL

SELECT '7401000473'
 , '740101001'
 , '202981' UNION ALL

SELECT '7709378229'
 , '770901001'
 , '56100' UNION ALL

SELECT '7709378229'
 , '770901001'
 , '1693078' UNION ALL

SELECT '7715898970'
 , ''
 , '1691198' UNION ALL

SELECT '7715898970'
 , ''
 , '1694507' UNION ALL

SELECT '5024114599'
 , ''
 , '1691202' UNION ALL

SELECT '5024114599'
 , ''
 , '1694508' UNION ALL

SELECT '5408113828'
 , ''
 , '1691106' UNION ALL

SELECT '5408113828'
 , ''
 , '1693062' UNION ALL

SELECT '7202077506'
 , '720301001'
 , '1691090' UNION ALL

SELECT '7202077506'
 , '720301001'
 , '1693053' UNION ALL

SELECT '0274018070'
 , '27401001'
 , '608905' UNION ALL

SELECT '0274018070'
 , '27401001'
 , '180408' UNION ALL

SELECT '2465094460'
 , '246501001'
 , '199908' UNION ALL

SELECT '2465094460'
 , '246501001'
 , '1181760' UNION ALL

SELECT '7801017440'
 , '783801001'
 , '1069613' UNION ALL

SELECT '7801017440'
 , '783801001'
 , '141817' UNION ALL

SELECT '5401172158'
 , '540101001'
 , '1693057' UNION ALL

SELECT '5401172158'
 , '540101001'
 , '1692455' UNION ALL

SELECT '7801392271'
 , '780201001'
 , '1070543' UNION ALL

SELECT '7801392271'
 , '780201001'
 , '941613' UNION ALL

SELECT '0278064864'
 , '27801001'
 , '199896' UNION ALL

SELECT '0278064864'
 , '27801001'
 , '114143' UNION ALL

SELECT '1831053557'
 , '183101001'
 , '259441' UNION ALL

SELECT '1831053557'
 , '183101001'
 , '259439' UNION ALL

SELECT '7730163480'
 , '231702001'
 , '226342' UNION ALL

SELECT '7730163480'
 , '231702001'
 , '241813' UNION ALL

SELECT '2204056679'
 , '220250001'
 , '359764' UNION ALL

SELECT '2204056679'
 , '220250001'
 , '350397' UNION ALL

SELECT '3528155343'
 , '352801001'
 , '314880' UNION ALL

SELECT '3528155343'
 , '352801001'
 , '215588' UNION ALL

SELECT '7814037940'
 , '781401001'
 , '217248' UNION ALL

SELECT '7814037940'
 , '781401001'
 , '92032' UNION ALL

SELECT '1831039979'
 , '183101001'
 , '83539' UNION ALL

SELECT '1831039979'
 , '183101001'
 , '511820' UNION ALL

SELECT '5504001891'
 , '550401001'
 , '86218' UNION ALL

SELECT '5504001891'
 , '550401001'
 , '37617' UNION ALL

SELECT '7202191495'
 , '720301001'
 , '86325' UNION ALL

SELECT '7202191495'
 , '720301001'
 , '717090' UNION ALL

SELECT '7704188471'
 , '770401001'
 , '62053' UNION ALL

SELECT '7704188471'
 , '770401001'
 , '117839' UNION ALL

SELECT '4218006431'
 , '421801001'
 , '197225' UNION ALL

SELECT '4218006431'
 , '421801001'
 , '197221' UNION ALL

SELECT '6320001156'
 , '632001001'
 , '4200' UNION ALL

SELECT '6320001156'
 , '632001001'
 , '259443' UNION ALL

SELECT '6672213716'
 , '667201001'
 , '214106' UNION ALL

SELECT '6672213716'
 , '667201001'
 , '61338' UNION ALL

SELECT '5503024790'
 , '550301001'
 , '58864' UNION ALL

SELECT '5503024790'
 , '550301001'
 , '255128'

) tt

/*

SELECT F.INN, FJ.KPP, F2.INN, F2.KPP, F2.ID, 'ERROR: ' + case when isNULL(F.INN, '') <> F2.INN and isNULL(FJ.KPP, '') <> F2.KPP then 'INN and KPP' when isNULL(F.INN, '') <> F2.INN and isNULL(FJ.KPP, '') = F2.KPP then 'INN' else 'KPP' end

, FJ.Name

FROM Face F

 left join FaceJuridical FJ on F.FaceID = FJ.FaceID

full join #MyTbl F2 on F.FaceID = F2.ID

WHERE not (isNULL(F.INN, '') = F2.INN and isNULL(FJ.KPP, '') = '0'+F2.KPP) and (isNULL(F.INN, '') <> F2.INN or isNULL(FJ.KPP, '') = F2.KPP)

*/

SELECT F.INN, FJ.KPP, F2.INN, F2.KPP, F2.ID, 'ERROR: ' + case when isNULL(F.INN, '') <> F2.INN and isNULL(FJ.KPP, '') <> F2.KPP then 'INN and KPP' when isNULL(F.INN, '') <> F2.INN and isNULL(FJ.KPP, '') = F2.KPP then 'INN' else 'KPP' end

, FJ.Name, FJ.AreaID AreaID, A.Brief Area,

 (select dbo.Concatenate(convert(varchar(max), Adr) + '; ') A


FROM (
SELECT Address Adr, F.FaceID FID


FROM Address


WHERE FaceID = F.FaceID and AdressTypeID = 2) t


GROUP by FID

 ) Address

FROM Face F

 left join FaceJuridical FJ on F.FaceID = FJ.FaceID

 left join Area A on A.AreaID = FJ.AreaID

full join #MyTbl F2 on F.FaceID = F2.ID

WHERE not (isNULL(F.INN, '') = F2.INN and isNULL(FJ.KPP, '') = '0'+F2.KPP) and (isNULL(F.INN, '') <> F2.INN or isNULL(FJ.KPP, '') <> F2.KPP)

Select 'Выполнено.' as Result

commit tran