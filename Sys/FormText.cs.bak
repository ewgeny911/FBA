
﻿/*
 * Создано в SharpDevelop.
 * Пользователь: Травин
 * Дата: 30.09.2017
 * Время: 22:30
 */
 
using System;
using System.Drawing;
using System.Windows.Forms;
namespace FBA
{      
    public partial class FormText : FormSim
    {
        public FormText()
        {            
            InitializeComponent();             
            this.MdiParent = sys.FormMainObj; 
            this.Icon = this.MdiParent.Icon;  
            TextRefresh();               
            /*System.Windows.Forms.DataGridViewCellStyle dataGridViewCellStyle21 = new System.Windows.Forms.DataGridViewCellStyle();
            dataGridViewCellStyle21.Alignment = System.Windows.Forms.DataGridViewContentAlignment.MiddleCenter;
            dataGridViewCellStyle21.BackColor = System.Drawing.SystemColors.GradientActiveCaption; //Control;
            dataGridViewCellStyle21.Font      = new System.Drawing.Font("Arial", 11.25F, System.Drawing.FontStyle.Bold, System.Drawing.GraphicsUnit.Point, ((byte)(204)));          
            dataGridViewCellStyle21.WrapMode  = System.Windows.Forms.DataGridViewTriState.True;                
            this.dgvText.DefaultCellStyle     =  dataGridViewCellStyle21;
            this.dgvText.ColumnHeadersDefaultCellStyle = dataGridViewCellStyle21;
            this.dgvText.RowHeadersDefaultCellStyle = dataGridViewCellStyle21;*/             
        }
        
        /*public void tbTextRefresh_Click(object sender, EventArgs e)
        {
            string SenderName = sys.GetSenderName(sender);
            string TextID   = sys.DGSelected(dgvText, "ID"); 
            
            //Обновить таблицу с текстами.
            if (SenderName == "tbTextRefresh") TextRefresh();
            
            //Добавить текст.
            if (SenderName == "tbTextAdd") TextAdd();
            
            //Удалить текст.
            if (SenderName == "tbTextDel") TextDel(TextID);
            
            //Сохранить текст.
            if (SenderName == "tbTextSave") TextSave(TextID);
        } */
        
        ///Добавить текст.
        public bool TextAdd()
        {           
            string NameText  = ""; 
            string ValueText = "";                   
            if (!sys.InputValue2("Введите текст", "Название:", "Текст:", ref NameText, ref ValueText)) return false;       
            string SQL = "INSERT INTO arhText (" +
                         "UserCreateID, DateCreate, Name, Value) VALUES (" + 
                         sys.UserID + ", " + sys.DateTimeCurrent() + ",'" + NameText + "','" + ValueText + "')" ;
            if (!sys.Exec("Remote", SQL)) return false; 
            TextRefresh();
            SelectText();
            sys.SM("Текст добавлен!", "Information");
            return true;
        }
        
        ///Удалить текст.
        public bool TextDel(string TextID)
        {
            if (TextID == "") return false;
            string SQL = "DELETE FROM arhText WHERE ID = " + TextID;
            if (!sys.Exec("Remote", SQL)) return false; 
            TextRefresh();         
            tbName.Text = "";
            tbText.Text = "";
            SelectText();
            sys.SM("Текст удален!", "Information");
            return true;
        }
        
        ///Сохранить текст.
        public bool TextSave(string TextID)
        {
            if (TextID == "") return false;
            string SQL = "UPDATE arhText SET " +
                "UserChangeID = " + sys.UserID +
                ", DateChange = " + sys.DateTimeCurrent() +
                ", Name  = '" + tbName.Text + "'" +
                ", Value = '" + tbText.Text + "'" +
                " WHERE ID = " + TextID;
            if (!sys.Exec("Remote", SQL)) return false; 
            TextRefresh();
            sys.SM("Текст сохранён!", "Information");
            return true;                
        }
        
        ///Показ текста.
        public bool TextRefresh()
        {
               const string SQL = 
                    "SELECT ID, " +
                    "Name, " +                                        
                    "SUBSTR(Value, 1, 50) AS Text, " +  
                    "UserChangeID, " +
                    "UserCreateID, " +
                    "DateChange, " +
                    "DateCreate " +                                   
                    "FROM arhText";            
               if (!sys.SelectGV("Remote", SQL, dgvText)) return false;
               return true;
        }
        
        ///Показ текста.
        private bool SelectText()
        {
            string TextID   = sys.DGSelected(dgvText, "ID");             
            if (TextID == "") return false;
            string FileData;
            string TextName;         
            string SQL = "SELECT Value, Name FROM arhText WHERE ID = " + TextID;
            if (!sys.GetValue2("Remote", SQL, 
                               out FileData, 
                               out TextName)) return false;
            if (FileData == "") 
            {
                sys.SM("Не найден текст в таблице текстов!");
                return false;
            }            
            tbName.Text = TextName;
            tbText.Text = FileData;  
            return true;
        }
        
        ///При выборе текста в таблице показываем его. 
        private void dgvText_DoubleClick(object sender, EventArgs e)
        {
            SelectText();
        }
        
        //Кнопки контекстного меню на таблице текстов.
        private void cmText_N1_Click(object sender, EventArgs e)
        {
            string SenderName = sys.GetSenderName(sender);
            string TextID   = sys.DGSelected(dgvText, "ID"); 
                           
            //Добавить текст.
            if (SenderName == "cmText_N1") TextAdd();
            
            //Удалить текст.
            if (SenderName == "cmText_N2") TextDel(TextID);
            
            //Сохранить текст.
            if (SenderName == "cmText_N3") TextSave(TextID);
            
            //Обновить таблицу с текстами.
            if (SenderName == "cmText_N4") TextRefresh();
            
        }    
    } 
}
