 
  Выбрать
  ДатаСостОбъекта,
  DateEnd.ДатаСостАтрибута,
  DateEnd
Из
 Contract
 where ObjectID = 111174205


 
  SELECT Наим FROM АтрибутСущности;
  
  
  Выбрать
  ОУ.ФЛ.ФИОПолные 'ФИО',
  ОУ.ФЛ.ДатаРождения 'Дата Рождения',
  ОУ.СтрахПолис.Номер 'Номер',
--  ОУ.СтрахПолис.Застрахованный.ОтношениеКСтрахователю.Наим 'Отношение к Страхователю',
--  ОУ.ФЛ.Родственники.РодственникФЛ.НаимSQL 'ФИО родственника',
  ОУ.ДатаУслуги 'Дата услуги',
  ОУ.СуммаВыплаты 'Сумма к выплате',
  ОУ.Услуга.Валюта.Сокр 'Валюта',
  ОУ.РеестрУслуг.СчетЛПУ.ДатаОплатыФакт 'Дата Оплаты Фактовая',
  ОУ.Услуга.Наименование 'Наименование услуги',
  ОУ.РеестрУслуг.Исполнитель.Код 'Код ЛПУ',
  ОУ.РеестрУслуг.Исполнитель.Регион.Код  'Код Региона ЛПУ',
  ОУ.РеестрУслуг.Исполнитель.Регион.Наим 'Регион ЛПУ',
  ОУ.РеестрУслуг.Исполнитель.Регион.Сокр 'Город ЛПУ',
  ОУ.РеестрУслуг.Исполнитель.Наим 'ЛПУ',
  ОУ.СтрахПолис.Застрахованный.ДогСтрах.Номер 'Номер договора',
  ОУ.СтрахПолис.Застрахованный.ДогСтрах.Страхователь.НаимSQL 'Страхователь',
  ОУ.СтрахПолис.Застрахованный.ДогСтрах.ДатаНачала 'Дата начала действия договора',
  ОУ.СтрахПолис.Застрахованный.ДогСтрах.ДатаОкончания 'Дата окончания действия договора',
--  ОУ.СтрахПолис.Застрахованный.ДогСтрах.Премия 'Страховая премия',
--  ОУ.СтрахПолис.Застрахованный.ДогСтрах.ПремияДМС 'Страховая премия ДМС',
--  ОУ.СтрахПолис.Застрахованный.ДогСтрах.Страхователь.НаимСущностиОбъекта 'Тип Страхователя',
--  ОУ.СтрахПолис.Застрахованный.ДогСтрах.ТипДогСтрах.Наим  'Тип договора',
--  ОУ.СтрахПолис.Застрахованный.ДогСтрах.Подразделение.ЮЛ.НаимSQL 'Подразделение',
--  ОУ.СтрахПолис.Застрахованный.ДогСтрах.СтрахПродукт.Наим 'Страховой продукт',
  ОУ.СтрахПолис.Застрахованный.ДогСтрах.Ремарка 'Группа',
--  ОУ.СтрахПолис.Застрахованный.ДогСтрах.КаналПродаж.Наим 'Канал продаж',
  Coalesce(
    (select top 1 ВЗ.ВариантДогСтрах.Наим
      from ВариантЗастрахованный ВЗ
      where ВЗ.Застрахованный.ИДОбъекта = ОУ.СтрахПолис.Застрахованный
        and ВЗ.ДатаОкончания >= ОУ.ДатаУслуги
        and ВЗ.ДатаНачала <= ОУ.ДатаУслуги),
    (select top 1 З.Вариант.ВариантДогСтрах.Наим
      from Застрахованный З
      where З.ИДОбъекта = ОУ.СтрахПолис.Застрахованный
        and З.ДатаСостОбъекта = ОУ.ДатаУслуги),
        ''
    ) as 'Вариант',
  ОУ.РеестрУслуг.СчетЛПУ.Прикрепление 'Прикрепление',
  ОУ.ТипПомощи.Наим 'Тип помощи'
  ,month(ОУ.ДатаУслуги) 'Месяц'
  ,year(ОУ.ДатаУслуги) 'Год'
Из
  ОказанныеУслуги ОУ   WITH NOLOCK
где
  --УСТАНАВЛИВАЕМ ДАТУ:
  ОУ.СуммаВыплаты <> 0
--  and ОУ.СтрахПолис.Застрахованный.ДогСтрах.ДатаОкончания >= '01.01.2016'
--  and ОУ.ДатаУслуги  >= '01.05.2016' --дата оказания услуг
  and ОУ.ДатаУслуги <= '30.06.2016'     
       
       
       
       
       
select D1.Номер, D1.СчетЛПУ, D1.ВидДок, D1.ТекущийСтатус, D1.Сумма,
(select count(ИДОбъекта) cnt
 from ОказанныеУслуги P1
 where P1.РеестрУслуг = D1.СчетЛПУ.РеестрУслуг) cnt
from ДокНаИсхОплату D1
where ИДОбъекта = 2024984




select top 1 * from ДокНаВхОплату into #t1; 
select * from #t1

Select
  Застрахованный.ФЛ.ФИОПолные "FIO",
  Застрахованный.ФЛ.ДатаРождения "Birth",
  Застрахованный.Полис.Номер "Policy",
  Застрахованный.ДогСтрах.Страхователь.НаимSQL "Insurer",
  Застрахованный.Регион.Наим "Region",
  ТипЖалобыСправочник.Наим "TypeAppeal",
  ТипОбращенияДП.Наим "TypeCall",
  ДатаЗаявки "RegDate",
  '[' + КодОтветчика.Код + '] ' + КодОтветчика.Наим "CodeDef",
  '[' + КодФункОтветчикаСК.Код + '] ' + КодФункОтветчикаСК.Наим "CodeFuncIC",
  '[' + КодФункОрганизации.Код + '] ' + КодФункОрганизации.Наим "CodeFuncComp",
  СтатусИсполнения.Наим "StatusExec",
  ДопСтатус.Наим "StatusDop",
  Содержание "NoteAppeal",
  Примечание "Comments"
From
  Жалоба
Where
  ДатаЗаявки >= '20170101 00:00:00' and ДатаЗаявки <= '20181024 00:00:00'
Order By
  ДатаЗаявки , Застрахованный.ФЛ.ФИОПолные , Застрахованный.ФЛ.ДатаРождения , Застрахованный.Полис.Номер

  
Select top 1
  t1.Примечание,
  (выбрать top 1 t2.Name from JuridicalOrgStatus t2 where t2.Name = t1.Примечание) as gggg 
from
 Жалоба t1

  
  
                 
 select top 10 * from  JuridicalOrgStatus
select top 10 * from ДокНаВхОплату

SELECT 123


SELECT Полис.Номер PolisNumber,
       ФЛ.НаФа Surname,
       ФЛ.Имя Firstname,
       ФЛ.Отчество Patronymic,
       ФЛ.НаимОбъекта FIO,
       ФЛ.ДатаРождения BirthDate,
       ФЛ.Возраст Age,
       Вариант.ВариантДогСтрах.Наим Variant,
       Коэффициент Coeff,
       ДатаНачала StartDate,
       ФЛ.АдресПроживанияSQL FactAdr,
       case IsNull((SELECT TOP 1 И.ИДОбъекта FROM Инвалидность И WHERE И.ФЛ = Застрахованный.ФЛ
             and И.ДатаНачала <= Застрахованный.ДатаНачала
             and IsNull(И.ДатаОкончания, '30000101') >= Застрахованный.ДатаНачала), 0)
          when 0 then 'Нет'
          else 'Да'
        end Invalid,
       ФЛ.ТелефонДомашний HomePhone,
       ФЛ.ТелефонРабочий WorkPhone,
       ФЛ.Должность Proff,
       Регион.Наим City,
       АдресМестаРаботы DelivAdr,
       ФЛ.Подразделение.Наим Podr,
       case
        when ГО = 'ГО' then 'ГО'
        when Филиал like '%СЗ%' then 'СЗРЦ'
        else 'Филиал'
       end as Gow,
       case
         when ГО = 'ГО' then 'ГО'
         else Филиал
       end as Filial,
       Референс Referenc
  FROM Застрахованный
 WHERE Основание = 2039259
   AND ДатаСостОбъекта = '20160601 00:00:00'
   AND Операция = 1
   AND ДатаНачала = '20160601 00:00:00' ORDER BY Gow, Filial, FIO
   
   
  



  select ИДОбъекта, Номер from ДогСтрах where Застрахованные.КоличОбъектовМассива > 1000   





--1.
Select
  distinct
  1 ID,
  tt.InsAction InsAction,
  tt.Insured Insured,
  tt.OV,
  tt.OFil,
    Case
    When tt.InsAction = 3 Then convert(varchar(10), tt.OBD, 104)
    Else NULL
  End
OldBirthDate,
  isNULL(
  (--2
     Select PayPrem From GetAllProgram(tt.Insured, 1213, '20180423 00:00:00')), '')
  Programms,
  isNull(З1.ФЛ.НаФа, '')
  + ' ' + isNull(З1.ФЛ.Имя, '')
  + ' ' + isNull(З1.ФЛ.Отчество, '')
  FIO,
  З1.Полис.Номер Policy,
  З1.Полис.ДатаНачала PolicyStart,
  З1.Полис.ДатаОкончания PolicyEnd,
  З1.ДатаНачала StartDate,
  З1.ДатаОкончания EndDate,
  З1.ФЛ.НаФа Name1,
  З1.ФЛ.Имя Name2,
  З1.ФЛ.Отчество Name3,
  convert(varchar(10), З1.ФЛ.ДатаРождения, 104)
  BirthDate,
  З1.ФЛ.СтараяФамилия OldName1,
  З1.ФЛ.СтароеИмя OldName2,
  З1.ФЛ.СтароеОтчество OldName3,
  convert(varchar(10), З1.ФЛ.СтараяДатаРождения, 104)
  OldBirthDate,
  З1.ФЛ.ТелефонДомашний PhoneHome,
  З1.ФЛ.ТелефонРабочий PhoneWork,
  З1.ФЛ.ТелефонМобильный PhoneMobile,
  З1.ФЛ.Пол Sex,
  З1.ФЛ.Должность Position,
  isNULL(myFL.Нафа, myUL.Нафа)
  InsurerName,
  З1.ОтношениеКСтрахователю.Наим RelInsurer,
  З1.ФЛ.ЮЛ.Нафа WorkPlace,
  З1.Регион.Наим InsRegion,
  З1.АдресМестаРаботы WorkPlaceAddr,
  isNULL(tt.Address, З1.ФЛ.АдресПроживанияSQL)
  Address,
  tt.OldAddress OldAddress
From
  Застрахованный З1
  join (--3.
        Select 
        distinct
          Case
          When ResTable.CAction = 2 Then (--4.
          Select CAct From GetChangeProgram(ResTable.ObjID, 1213, '20180423 00:00:00'))
          When ResTable.CAction = - 1 and СВ.ДатаПрикрепления = '20180423 00:00:00' Then NULL
         Else ResTable.CAction
        End
        InsAction,
        ResTable.ObjID Insured,
        Case
        When ResTable.CAction = 2 and (--5.
        Select CAct From GetChangeProgram(ResTable.ObjID, 1213, '20180423 00:00:00')) = 1 Then NULL
          Else ResTable.OldVar
        End OV,
        Case
        When ResTable.CAction = 2 and (--6.
        Select CAct From GetChangeProgram(ResTable.ObjID, 1213, '20180423 00:00:00')) = 1 Then ''
          Else ResTable.OldFilial
        End OFil,
        convert(varchar(10), ResTable.OldBirthDate, 104)
        OBD,
        ResTable.Address Address,
        ResTable.OldAddress OldAddress
        From
        (
        --7. Выполняется
          Select
            1 CAction,
            t1.ИДОбъекта ObjID,
            NULL OldVar,
            '' OldFilial,
            '' OldBirthDate,
            t1.Вариант.ВариантДогСтрах ВДС,
            NULL Address,
            NULL OldAddress
          From
            Застрахованный t1
          Where
          t1.ДогСтрах = 125 AND isNull(t1.ОснованиеОткрепления, 0)
          <> 126 AND t1.ДатаСостОбъекта = '20180423 00:00:00' AND t1.Вариант.ДатаСостОбъекта = '20180423 00:00:00' AND t1.Вариант.ВариантДогСтрах.ДатаСостОбъекта = '20180423 00:00:00'
                 
            
            
          union all
                 
          
          
            --8. Выполняется
          Select
            - 1 CAction,
            t2.ИДОбъекта ObjID,
            NULL OldVar,
            '' OldFilial,
            '' OldBirthDate,
            t2.Вариант.ВариантДогСтрах ВДС,
            NULL,
            NULL
          From
            Застрахованный t2 ,
            Застрахованный t3
          Where
          t2.ДогСтрах = 124 AND t2.ОснованиеОткрепления = 123 AND t2.ИДОбъекта = t3.ИДОбъекта AND t3.ДатаОкончания > t2.ДатаОкончания AND t3.ДатаСостОбъекта = '20180422 00:00:00' AND t2.ДатаСостОбъекта = '20180423 00:00:00'

               
            
            union all

            
            
            --9.Выполняется

          Select
            2 CAction,
            t4.ИДОбъекта ObjID,
            t5.Вариант.ВариантДогСтрах OldVar,
            t5.Филиал OldFilial,
            '' OldBirthDate,
            t4.Вариант.ВариантДогСтрах ВДС,
            NULL,
            NULL
          From
            Застрахованный t4 ,
            Застрахованный t5
          Where
          t4.ДогСтрах = 127 AND t4.ИДОбъекта = t5.ИДОбъекта AND t4.Вариант.ВариантДогСтрах.Вариант <> t5.Вариант.ВариантДогСтрах.Вариант AND t4.ДатаСостОбъекта = '20180423 00:00:00' AND t5.ДатаСостОбъекта = '20180422 00:00:00'

            
            
          union all
              
          
          
          --10.Выполняется       
          Select
            1 CAction,
            ИДОбъекта ObjID,
            NULL OldVar,
            '' OldFilial,
            '' OldBirthDate,
            Вариант.ВариантДогСтрах ВДС,
            NULL Address,
            NULL OldAddress
            From
              Застрахованный
           Where
           ДогСтрах = 128 and Операция not in (2 , 4) and Основание <> 129 and ДатаСостОбъекта = '20180423 00:00:00' and ДатаОкончания.ДатаСостАтрибута = '20180423 00:00:00' and ДатаОкончания >= '20180423 00:00:00'

                
             
             
           union all

               
           

           --11. Выполняется
          Select
            3 CAction,
            t1.ИДОбъекта ObjID,
            NULL OldVar,
            '',
            t1.ФЛ.СтараяДатаРождения OldBirthDate,
            t1.Вариант.ВариантДогСтрах ВДС,
            NULL,
            NULL
          From
            Застрахованный t1
          Where
          t1.ДогСтрах = 130 AND (isNull(t1.ОснованиеОткрепления, 131) = 132) AND (t1.ФЛ.ДатаИзменения >
              (                
                  --12.
                  Select  max(StartDateT.ДатаНачала)
                  From
                  (--13.           
                     Select
                       max(ДатаНачала) ДатаНачала
                     From
                       ДопСоглашение
                     Where
                     ДатаНачала < '20180423 00:00:00' and Документ = 133


                     union all


                     --14.
                     Select
                       ДогС.ДатаНачала
                     From
                       ДогСтрах ДогС
                    Where
                    ДогС.ИДОбъекта = 134
              ) StartDateT
              ) and t1.ФЛ.ДатаИзменения <= '20110423 00:00:00') AND t1.ДатаСостОбъекта = '20120423 00:00:00'

               
          
          
          
          union all





          --Начало пункт 4. Выполняется
          --15.
          Select
            4 CAction,
            t1.ИДОбъекта ObjID,
            NULL OldVar,
            '',
            t1.ФЛ.СтараяДатаРождения OldBirthDate,
            t1.Вариант.ВариантДогСтрах ВДС,

            (--16.
             Select TOP 1
                Адрес
              From
                Адрес
              Where
                Лицо = t1.ФЛ AND ТипАдреса.Сокр = 'АдресПроживания'
              Order By
                ДатаРегистрации Desc
          ) Address,


          (--17.
           Select TOP 1 dat2.Адрес
            From
            (--18
            Select TOP 2 Адрес, ДатаРегистрации From Адрес Where Лицо = t1.ФЛ AND ТипАдреса.Сокр = 'АдресПроживания' Order By ДатаРегистрации Desc) dat2
            Order By dat2.ДатаРегистрации asc
            ) OldAddress
        From
          Застрахованный t1
        Where
        t1.ДогСтрах = 135 AND (isNull(t1.ОснованиеОткрепления, 136) = 137) AND (
          (--19.
          Select TOP 1  ДатаРегистрации From Адрес Where Лицо = t1.ФЛ.ИДОбъекта AND ТипАдреса.Сокр = 'АдресПроживания' Order By Основной Desc, ДатаРегистрации Desc) 
          between 
             (--20.
             Select max(StartDateT.ДатаНачала) From
               (--21.
               Select max(ДатаНачала) ДатаНачала From ДопСоглашение Where ДатаНачала < '20180423 00:00:00' and Документ = 138
                
                union all
                --22.
                Select ДогС.ДатаНачала From ДогСтрах ДогС  Where ДогС.ИДОбъекта = 139) StartDateT
                ) + 1 and '20180423 00:00:00') and (Case
                When (--23.
                Select TOP 1 ДатаРегистрации From Адрес Where Лицо = t1.ФЛ AND ТипАдреса.Сокр = 'АдресПроживания' Order By ДатаРегистрации Desc) = t1.ФЛ.ДатаРегистрации Then 0
            Else 1
          End) = 1 AND t1.ДатаСостОбъекта = '20180423 00:00:00'
           --Конец пункт 4.

     



      ) ResTable
      join СодержимоеВариантДогСтрах СВ On СВ.ВариантДогСтрах = ResTable.ВДС or СВ.ВариантДогСтрах = ResTable.OldVar
      Where
        (СВ.ДатаОткрепления > '20180422 00:00:00' or СВ.ДатаОткрепления is NULL)
        and СВ.ДатаПрикрепления <= '20180423 00:00:00' and СВ.ЛПУ = 1213
        and ((СВ.ПрограммаВариантДогСтрах.СтрахПрог.СпискиЛПУ = 1 and ResTable.CAction <> 2) or (ResTable.CAction = 2))

       
        
        
      union all
        
      
      


      --Начало Пункт 10. Выполняется
      Select --24.
        Case
          When (sum(AIT.InsAction) = 0) and (sum(AIT.InsProg) <> 0) Then 2
          Else sum(AIT.InsAction)
        End InsAction,
        AIT.Insured,
        NULL,
        '',
        '',
        NULL,
        NULL
      From  --from AIT

      (
      Select  --25.
          SumONProgs.InsAction,
          SumONProgs.Insured,
          sum(SumONProgs.InsProg)
          InsProg
          From --SumONProgs 
          (  
          
          
          
          --=======================
          Select --26. Выполняется
            distinct
              Case
              When СВ.ДатаПрикрепления = '20180423 00:00:00' and (isNull(СВ.ДатаОткрепления, '21250101 00:00:00') > '20180423 00:00:00') and isNULL(З.ОснованиеОткрепления, 0) <> 140 Then 1
                When СВ.ДатаПрикрепления < '20180423 00:00:00' and СВ.ДатаОткрепления = '20180422 00:00:00' Then - 1
              End InsAction,
              З.ИДОбъекта Insured,
              Case
                When СВ.ДатаПрикрепления = '20180423 00:00:00' and (isNull(СВ.ДатаОткрепления, '21250101 00:00:00') > '20180423 00:00:00') Then СВ.ПрограммаВариантДогСтрах.СтрахПрог
                When СВ.ДатаПрикрепления < '20180423 00:00:00' and СВ.ДатаОткрепления = '20180422 00:00:00' Then - СВ.ПрограммаВариантДогСтрах.СтрахПрог
              End InsProg

            From
              СодержимоеВариантДогСтрах СВ
              join ВариантЗастрахованный ВЗ On ВЗ.ВариантДогСтрах = СВ.ВариантДогСтрах and ВЗ.ДатаСостОбъекта = '20180423 00:00:00'
              join Застрахованный З         On З.Вариант = ВЗ.ИДОбъекта and З.ДатаСостОбъекта = '20180423 00:00:00'
            Where
            СВ.ПрограммаВариантДогСтрах.ВариантДогСтрах.ДогСтрах = 141 and ((СВ.ДатаПрикрепления = '20180423 00:00:00' and (isNull(СВ.ДатаОткрепления, '20180424 00:00:00')
              > '20180423 00:00:00')) or (СВ.ДатаПрикрепления < '20180423 00:00:00' 
              and СВ.ДатаОткрепления = '20180422 00:00:00')) 
              and СВ.ПрограммаВариантДогСтрах in (3067053 , 3067054 , 3067055 , 3067056 , 3067057 , 3067071 , 3067082 , 3067100 , 
              3067110 , 3067118 , 3067125 , 3067319 , 3067330 , 3067347 , 3067384 , 3067389 , 3070613 , 3070614 , 3070615 , 
              3070617 , 3070618 , 3070619 , 3070658 , 3070663 , 3070668 , 3070680 , 3070683 , 3070719 , 3070741 , 3070747 , 
              3070748 , 3070749 , 3070750 , 3070761 , 3070794 , 3070853 , 3070854 , 3070855 , 3070856 , 3070857 , 3070858 , 
              3070859 , 3070860 , 3070861 , 3070865 , 3070866 , 3070867 , 3070868) and З.ДатаОкончания >= '20180422 00:00:00' 
              and СВ.ЛПУ = 1213 and СВ.ПрограммаВариантДогСтрах.СтрахПрог.СпискиЛПУ = 1  
            --======================  
              
              
          ) SumONProgs
          Group By
            SumONProgs.InsAction , SumONProgs.Insured
      ) AIT
    Group By AIT.Insured
    Having not(sum(AIT.InsAction) = 0 and sum(AIT.InsProg) = 0)
    --Конец Пункт 10.

  ) tt



    On tt.Insured = З1.ИДОбъекта
  left outer join ДогСтрах myContrIns
    On myContrIns.ИДОбъекта = З1.ДогСтрах
  left outer join Лицо myF
    On myF.ИДОбъекта = myContrIns.Страхователь
  left outer join ФЛ myFL
    On myFL.ИДОбъекта = myF.ИДОбъекта
  left outer join ЮЛ myUL
    On myUL.ИДОбъекта = myF.ИДОбъекта
Where
  З1.ДогСтрах = 142
  and tt.InsAction is not NULL
  and З1.ДатаСостОбъекта = '20180423 00:00:00'
  and З1.Вариант.ДатаСостОбъекта = '20180423 00:00:00'
  and З1.Вариант.ВариантДогСтрах.ДатаСостОбъекта = '20180423 00:00:00'

  
